name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would happen without making changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  bump:
    name: Bump versions
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.bump.outputs.released }}
      released_packages: ${{ steps.bump.outputs.released_packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Bump all packages (unified commit + individual tags)
        id: bump
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            python3 scripts/bump_packages.py --dry-run
          else
            python3 scripts/bump_packages.py
          fi

      - name: Update lock file
        if: ${{ !inputs.dry_run && steps.bump.outputs.released != '' }}
        run: |
          uv sync
          git add uv.lock
          git commit --amend --no-edit || echo "No lock file changes"

      - name: Push changes and tags to main
        if: ${{ !inputs.dry_run && steps.bump.outputs.released != '' }}
        run: |
          git push origin main
          git push origin --tags

  publish:
    name: Publish ${{ matrix.package }}
    needs: bump
    if: ${{ !inputs.dry_run && needs.bump.outputs.released != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.bump.outputs.released_packages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Extract release info
        id: info
        run: python3 scripts/extract_release_info.py "${{ matrix.package }}" "${{ needs.bump.outputs.released }}"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Get package path
        id: pkg
        run: |
          PKG_PATH=$(python3 scripts/get_package_path.py "${{ matrix.package }}")
          echo "path=$PKG_PATH" >> $GITHUB_OUTPUT

      - name: Build package
        run: uv build --package ${{ matrix.package }}

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/create_github_release.py \
            "${{ matrix.package }}" \
            "${{ steps.info.outputs.version }}" \
            "${{ steps.info.outputs.tag }}" \
            "${{ steps.pkg.outputs.path }}"

      - name: Summary
        run: echo "✅ Published ${{ matrix.package }} ${{ steps.info.outputs.version }}"

  sync-develop:
    name: Sync develop branch
    needs: [bump, publish]
    if: ${{ !inputs.dry_run && needs.bump.outputs.released != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase develop onto main
        run: |
          git fetch origin main
          git rebase origin/main

      - name: Push updated develop
        run: |
          git push origin develop --force-with-lease

      - name: Summary
        run: echo "✅ develop branch rebased onto main"
