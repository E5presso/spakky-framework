name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would happen without making changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  bump:
    name: Bump version
    runs-on: ubuntu-latest
    outputs:
      released_version: ${{ steps.bump.outputs.released_version }}
      released_packages: ${{ steps.bump.outputs.released_packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Bump workspace version
        id: bump
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            python3 scripts/bump_packages.py --dry-run
          else
            python3 scripts/bump_packages.py
          fi

      - name: Update lock file
        if: ${{ !inputs.dry_run && steps.bump.outputs.released_version != '' }}
        run: |
          uv sync
          git add uv.lock
          git commit --amend --no-edit || echo "No lock file changes"

      - name: Create release tag
        if: ${{ !inputs.dry_run && steps.bump.outputs.released_version != '' }}
        run: |
          VERSION="${{ steps.bump.outputs.released_version }}"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          echo "ðŸ·ï¸ Created tag v${VERSION}"

      - name: Push changes and tag to main
        if: ${{ !inputs.dry_run && steps.bump.outputs.released_version != '' }}
        run: |
          git push origin main
          git push origin --tags

  publish:
    name: Publish ${{ matrix.package }}
    needs: bump
    if: ${{ !inputs.dry_run && needs.bump.outputs.released_version != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.bump.outputs.released_packages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Get package path
        id: pkg
        run: |
          PKG_PATH=$(python3 scripts/get_package_path.py "${{ matrix.package }}")
          echo "path=$PKG_PATH" >> $GITHUB_OUTPUT

      - name: Build package
        run: uv build --package ${{ matrix.package }}

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true

      - name: Summary
        run: echo "âœ… Published ${{ matrix.package }} v${{ needs.bump.outputs.released_version }}"

  github-release:
    name: Create GitHub Release
    needs: [bump, publish]
    if: ${{ !inputs.dry_run && needs.bump.outputs.released_version != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.bump.outputs.released_version }}"
          TAG="v${VERSION}"

          # Extract changelog section for this version
          # Uses sed to get content from "## vX.Y.Z" until (but not including) next "## v"
          sed -n '/^## v'"${VERSION}"'/,/^## v[0-9]/p' CHANGELOG.md | sed '$d' > release_notes.md

          # If this is the only version (no next ## v found), get everything from version header
          if [ ! -s release_notes.md ]; then
            sed -n '/^## v'"${VERSION}"'/,$p' CHANGELOG.md > release_notes.md
          fi

          # If still no content, add a minimal note
          if [ ! -s release_notes.md ]; then
            echo "## v${VERSION}" > release_notes.md
            echo "" >> release_notes.md
            echo "See the full changelog for details." >> release_notes.md
          fi

          # Append package list
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Packages Released:**" >> release_notes.md
          PACKAGES='${{ needs.bump.outputs.released_packages }}'
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "- \`${pkg}==${VERSION}\`" >> release_notes.md
          done

          gh release create "$TAG" \
            --title "v${VERSION}" \
            --notes-file release_notes.md

  sync-develop:
    name: Sync develop branch
    needs: [bump, publish, github-release]
    if: ${{ !inputs.dry_run && needs.bump.outputs.released_version != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase develop onto main
        run: |
          git fetch origin main
          git rebase origin/main

      - name: Push updated develop
        run: |
          git push origin develop --force-with-lease

      - name: Summary
        run: echo "âœ… develop branch rebased onto main"
