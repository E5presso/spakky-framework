name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would happen without making changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  bump:
    name: Bump versions
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.release-info.outputs.released }}
      released_packages: ${{ steps.release-info.outputs.released_packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Bump all packages
        id: release-info
        run: |
          PACKAGES=("spakky" "spakky-fastapi" "spakky-rabbitmq" "spakky-security" "spakky-typer")
          RELEASED_PACKAGES=()
          RELEASED_INFO=""

          for PACKAGE in "${PACKAGES[@]}"; do
            echo ""
            echo "========================================"
            echo "ðŸ“¦ Processing: $PACKAGE"
            echo "========================================"

            PKG_PATH=$(python3 scripts/get_package_path.py "$PACKAGE")
            if [ $? -ne 0 ]; then
              echo "âŒ Package '$PACKAGE' not found in workspace"
              exit 1
            fi
            echo "ðŸ“ Path: $PKG_PATH"

            # Auto-detect first release (no existing tags for this package)
            EXISTING_TAGS=$(git tag -l "${PACKAGE}-v*" | head -1)
            if [ -z "$EXISTING_TAGS" ]; then
              IS_FIRST_RELEASE="true"
              echo "ðŸ†• First release detected (no existing tags)"
            else
              IS_FIRST_RELEASE="false"
              echo "ðŸ“‹ Existing releases found"
            fi

            cd "$PKG_PATH"

            if [ "${{ inputs.dry_run }}" == "true" ]; then
              echo "ðŸ” Dry run mode:"
              if [ "$IS_FIRST_RELEASE" == "true" ]; then
                VERSION=$(uv run cz version --project)
                echo "  Would create first release: ${PACKAGE}-v${VERSION}"
              else
                uv run cz bump --dry-run --yes || echo "  â„¹ï¸ No commits to bump"
              fi
            else
              if [ "$IS_FIRST_RELEASE" == "true" ]; then
                VERSION=$(uv run cz version --project)
                TAG="${PACKAGE}-v${VERSION}"
                echo "ðŸ“Œ First release version: $VERSION"

                cd "$GITHUB_WORKSPACE"
                git tag -a "$TAG" -m "Release $TAG"
                echo "ðŸ·ï¸ Created tag: $TAG"

                RELEASED_PACKAGES+=("$PACKAGE")
                RELEASED_INFO="${RELEASED_INFO}${PACKAGE}:${VERSION}:${TAG};"
              else
                if uv run cz bump --yes --changelog; then
                  VERSION=$(uv run cz version --project)
                  TAG="${PACKAGE}-v${VERSION}"
                  echo "âœ… Bumped to: $VERSION"

                  RELEASED_PACKAGES+=("$PACKAGE")
                  RELEASED_INFO="${RELEASED_INFO}${PACKAGE}:${VERSION}:${TAG};"
                else
                  EXIT_CODE=$?
                  if [ $EXIT_CODE -eq 21 ]; then
                    echo "âš ï¸ No commits to bump for $PACKAGE - skipping"
                  else
                    exit $EXIT_CODE
                  fi
                fi
              fi
            fi

            cd "$GITHUB_WORKSPACE"
          done

          echo "released=$RELEASED_INFO" >> $GITHUB_OUTPUT

          if [ ${#RELEASED_PACKAGES[@]} -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "ðŸ“‹ Released packages: ${RELEASED_PACKAGES[*]}"
            echo "========================================"
            JSON=$(printf '%s\n' "${RELEASED_PACKAGES[@]}" | jq -R . | jq -s -c .)
            echo "released_packages=$JSON" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "â„¹ï¸ No packages were released"
            echo "released_packages=[]" >> $GITHUB_OUTPUT
          fi

      - name: Update lock file
        if: ${{ !inputs.dry_run && steps.release-info.outputs.released != '' }}
        run: |
          uv sync
          git add uv.lock
          git commit -m "chore: update uv.lock after version bump" || echo "No lock file changes"
          echo "ðŸ”’ Updated uv.lock file"

      - name: Push all changes and tags
        if: ${{ !inputs.dry_run && steps.release-info.outputs.released != '' }}
        run: |
          git push origin HEAD
          git push origin --tags
          echo "ðŸš€ Pushed all commits and tags"

  publish:
    name: Publish ${{ matrix.package }}
    needs: bump
    if: ${{ !inputs.dry_run && needs.bump.outputs.released != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.bump.outputs.released_packages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin HEAD

      - name: Extract release info
        id: check
        run: |
          RELEASED='${{ needs.bump.outputs.released }}'
          PACKAGE='${{ matrix.package }}'

          INFO=$(echo "$RELEASED" | tr ';' '\n' | grep "^${PACKAGE}:")
          VERSION=$(echo "$INFO" | cut -d: -f2)
          TAG=$(echo "$INFO" | cut -d: -f3)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ $PACKAGE v$VERSION will be published"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Get package path
        id: pkg
        run: |
          PKG_PATH=$(python3 scripts/get_package_path.py "${{ matrix.package }}")
          echo "path=$PKG_PATH" >> $GITHUB_OUTPUT

      - name: Build package
        run: uv build --package ${{ matrix.package }}

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.check.outputs.tag }}"
          CHANGELOG_PATH="${{ steps.pkg.outputs.path }}/CHANGELOG.md"

          if [ -f "$CHANGELOG_PATH" ]; then
            NOTES=$(cat "$CHANGELOG_PATH" | head -100)
          else
            NOTES="Release $TAG"
          fi

          gh release create "$TAG" \
            --title "${{ matrix.package }} ${{ steps.check.outputs.version }}" \
            --notes "$NOTES" \
            dist/* || echo "Release may already exist"

      - name: Summary
        run: echo "âœ… Published ${{ matrix.package }} ${{ steps.check.outputs.version }}"
